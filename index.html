<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Humanitarian Core Data API Catalogue</title>
    <script src="auth.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-top">
                <h1>Humanitarian Core Data API Catalogue</h1>
                <div class="last-updated" id="last-updated">Last updated: <span id="update-date">Loading...</span></div>
            </div>
            <p>Browse and discover core humanitarian datasets with comprehensive metadata, API access, and technical documentation.</p>
            <nav class="header-nav">
                <a href="index.html">Catalogue</a>
                <a href="domains.html">Domain Definitions</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <section class="filter-section">
            <h2>Filter Datasets</h2>
            <div class="filters">
                <div class="filter-group">
                    <label for="domain-filter">Domain</label>
                    <select id="domain-filter">
                        <option value="">All Domains</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="org-filter">Organization</label>
                    <select id="org-filter">
                        <option value="">All Organizations</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="country-filter">Countries</label>
                    <select id="country-filter">
                        <option value="">All Countries</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="freq-filter">Publication Frequency</label>
                    <select id="freq-filter">
                        <option value="">All Frequencies</option>
                        <option value="Daily">Daily</option>
                        <option value="Weekly">Weekly</option>
                        <option value="Monthly">Monthly</option>
                        <option value="Bi-monthly">Bi-monthly</option>
                        <option value="Quarterly">Quarterly</option>
                        <option value="Annually">Annually</option>
                    </select>
                </div>
                <div class="filter-group" id="dimensions-filter-group" style="display: none;">
                    <label for="dimensions-filter">Dimensions</label>
                    <select id="dimensions-filter">
                        <option value="">All Dimensions</option>
                    </select>
                    <div class="filter-hint">Tags like "real-time", "validated"</div>
                </div>
                <div class="filter-group">
                    <label for="search-filter">Search</label>
                    <input type="text" id="search-filter" placeholder="Search datasets...">
                </div>
                <div class="filter-group">
                    <label for="dataset-select-toggle">Select Datasets</label>
                    <div class="custom-multiselect">
                        <button type="button" class="multiselect-toggle" id="dataset-select-toggle" onclick="toggleDatasetDropdown()">
                            <span id="dataset-select-label">All datasets</span>
                            <span class="dropdown-arrow">‚ñº</span>
                        </button>
                        <div class="multiselect-dropdown" id="dataset-dropdown" style="display: none;">
                            <div class="multiselect-search">
                                <input type="text" id="dataset-search" placeholder="Search datasets..." onkeyup="filterDatasetOptions()">
                            </div>
                            <div class="multiselect-options" id="dataset-options">
                                <!-- Populated dynamically -->
                            </div>
                            <div class="multiselect-actions">
                                <button type="button" onclick="selectAllDatasetsCheckbox()" class="multiselect-btn">Select All</button>
                                <button type="button" onclick="clearAllDatasetsCheckbox()" class="multiselect-btn">Clear All</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="filter-actions">
                <button class="reset-btn" onclick="resetFilters()">Reset All Filters</button>
                <button class="select-all-btn" onclick="selectAllDatasets()">Select All Datasets</button>
            </div>
        </section>

        <div class="view-toggle">
            <div class="results-info" id="results-info">
                Loading datasets...
            </div>
            <div class="view-buttons">
                <button class="view-btn" onclick="switchView('cards')" id="cards-btn">üìã Cards</button>
                <button class="view-btn active" onclick="switchView('table')" id="table-btn">üìä Table</button>
                <button class="view-btn export-btn" onclick="exportToCSV()">‚¨áÔ∏è Export CSV</button>
                <button class="view-btn export-btn" onclick="exportToExcel()">‚¨áÔ∏è Export Excel</button>
            </div>
        </div>

        <div id="datasets-container">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading datasets...</p>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-text">
                <p>Humanitarian Core Data API Catalogue</p>
                <p style="font-size: 0.75rem; opacity: 0.6; margin-top: 0.25rem;">Contact your data team for updates or corrections</p>
            </div>
            <div class="footer-logos">
                <a href="https://data.humdata.org" target="_blank" class="footer-logo" title="Humanitarian Data Exchange">
                    <svg width="120" height="40" viewBox="0 0 120 40" fill="none">
                        <text x="10" y="25" font-family="Source Sans Pro" font-weight="700" font-size="18" fill="white">HDX</text>
                    </svg>
                </a>
                <a href="https://centre.humdata.org" target="_blank" class="footer-logo" title="Centre for Humanitarian Data">
                    <svg width="160" height="40" viewBox="0 0 160 40" fill="none">
                        <text x="10" y="25" font-family="Source Sans Pro" font-weight="600" font-size="14" fill="white">HUMANITARIAN</text>
                        <text x="10" y="36" font-family="Source Sans Pro" font-weight="600" font-size="10" fill="rgba(255,255,255,0.7)">DATA CENTRE</text>
                    </svg>
                </a>
                <a href="https://www.unocha.org" target="_blank" class="footer-logo" title="OCHA">
                    <svg width="100" height="40" viewBox="0 0 100 40" fill="none">
                        <text x="10" y="25" font-family="Source Sans Pro" font-weight="700" font-size="20" fill="white">OCHA</text>
                    </svg>
                </a>
            </div>
        </div>
    </footer>

    <script>
        // Simple password protection
        if (sessionStorage.getItem("hdx_auth") !== "authorized") {
            const password = prompt("üîí Enter password to access the catalogue:");
            if (!password || password !== "humanitarian2026") {
                document.body.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column; font-family: 'Source Sans Pro', sans-serif;">
                        <h1 style="color: #2c3e50; margin-bottom: 1rem;">Access Denied</h1>
                        <p style="color: #718096;">Invalid password. Please refresh the page to try again.</p>
                    </div>
                `;
            } else {
                sessionStorage.setItem("hdx_auth", "authorized");
            }
        }

        let allDatasets = [];
        let filteredDatasets = [];
        let currentView = 'table';
        let sortColumn = null;
        let sortDirection = 'asc';
        let selectedDatasetNames = [];

        // Set last updated date (automatic from CSV file modification would require server-side)
        // For now, set to current date
        document.getElementById('update-date').textContent = new Date().toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });

        // Load and parse CSV
        async function loadDatasets() {
            try {
                const response = await fetch('datasets.csv');
                const csvText = await response.text();
                allDatasets = parseCSV(csvText);
                filteredDatasets = [...allDatasets];
                
                populateFilters();
                renderDatasets();
            } catch (error) {
                document.getElementById('datasets-container').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <h3>Error Loading Datasets</h3>
                        <p>Unable to load datasets.csv. Please check the file exists and is properly formatted.</p>
                    </div>
                `;
                console.error('Error loading datasets:', error);
            }
        }

        // Simple CSV parser
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            return lines.slice(1).map(line => {
                const values = parseCSVLine(line);
                const dataset = {};
                headers.forEach((header, index) => {
                    dataset[header] = values[index] ? values[index].trim() : '';
                });
                return dataset;
            }).filter(d => d['Dataset Name']);
        }

        // Handle CSV with commas in quoted fields
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        // Populate filter dropdowns
        function populateFilters() {
            // Domains
            const domains = [...new Set(allDatasets.map(d => d.Domain).filter(Boolean))].sort();
            const domainSelect = document.getElementById('domain-filter');
            domains.forEach(domain => {
                const option = document.createElement('option');
                option.value = domain;
                option.textContent = domain;
                domainSelect.appendChild(option);
            });

            // Organizations
            const orgs = [...new Set(allDatasets.map(d => d['Organization']).filter(Boolean))].sort();
            const orgSelect = document.getElementById('org-filter');
            orgs.forEach(org => {
                const option = document.createElement('option');
                option.value = org;
                option.textContent = org;
                orgSelect.appendChild(option);
            });

            // Countries
            const countries = [...new Set(allDatasets.map(d => d.Countries).filter(Boolean))].sort();
            const countrySelect = document.getElementById('country-filter');
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countrySelect.appendChild(option);
            });

            // Dimensions (tags) - auto-enables if data is present
            const allDimensions = [...new Set(allDatasets.flatMap(d => 
                d.Dimensions ? d.Dimensions.split(';').map(dim => dim.trim()) : []
            ))].filter(Boolean).sort();
            
            if (allDimensions.length > 0) {
                const dimensionsSelect = document.getElementById('dimensions-filter');
                const dimensionsGroup = document.getElementById('dimensions-filter-group');
                
                allDimensions.forEach(dim => {
                    const option = document.createElement('option');
                    option.value = dim;
                    option.textContent = dim;
                    dimensionsSelect.appendChild(option);
                });
                
                // Show the filter
                dimensionsGroup.style.display = 'flex';
            }

            // Dataset checkbox dropdown
            const datasetOptions = document.getElementById('dataset-options');
            allDatasets.forEach((dataset, index) => {
                const option = document.createElement('div');
                option.className = 'multiselect-option';
                option.innerHTML = `
                    <input type="checkbox" id="dataset-${index}" value="${dataset['Dataset Name']}" onchange="updateDatasetSelection()">
                    <label for="dataset-${index}">${dataset['Dataset Name']} (${dataset['Organization']})</label>
                `;
                datasetOptions.appendChild(option);
            });
        }

        // Toggle dataset dropdown
        function toggleDatasetDropdown() {
            const dropdown = document.getElementById('dataset-dropdown');
            const toggle = document.getElementById('dataset-select-toggle');
            
            if (dropdown.style.display === 'none') {
                dropdown.style.display = 'flex';
                toggle.classList.add('active');
                // Close when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', closeDropdownOnClickOutside);
                }, 0);
            } else {
                dropdown.style.display = 'none';
                toggle.classList.remove('active');
                document.removeEventListener('click', closeDropdownOnClickOutside);
            }
        }

        function closeDropdownOnClickOutside(event) {
            const dropdown = document.getElementById('dataset-dropdown');
            const toggle = document.getElementById('dataset-select-toggle');
            const container = dropdown.parentElement;
            
            if (!container.contains(event.target)) {
                dropdown.style.display = 'none';
                toggle.classList.remove('active');
                document.removeEventListener('click', closeDropdownOnClickOutside);
            }
        }

        // Filter dataset options in dropdown
        function filterDatasetOptions() {
            const search = document.getElementById('dataset-search').value.toLowerCase();
            const options = document.querySelectorAll('.multiselect-option');
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(search) ? 'flex' : 'none';
            });
        }

        // Select all datasets checkbox
        function selectAllDatasetsCheckbox() {
            const checkboxes = document.querySelectorAll('#dataset-options input[type="checkbox"]');
            const visibleCheckboxes = Array.from(checkboxes).filter(cb => cb.parentElement.style.display !== 'none');
            visibleCheckboxes.forEach(cb => cb.checked = true);
            updateDatasetSelection();
        }

        // Clear all datasets checkbox
        function clearAllDatasetsCheckbox() {
            const checkboxes = document.querySelectorAll('#dataset-options input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateDatasetSelection();
        }

        // Update dataset selection and label
        function updateDatasetSelection() {
            const checkboxes = document.querySelectorAll('#dataset-options input[type="checkbox"]:checked');
            selectedDatasetNames = Array.from(checkboxes).map(cb => cb.value);
            
            const label = document.getElementById('dataset-select-label');
            if (selectedDatasetNames.length === 0) {
                label.textContent = 'All datasets';
            } else if (selectedDatasetNames.length === 1) {
                label.textContent = '1 dataset selected';
            } else {
                label.textContent = `${selectedDatasetNames.length} datasets selected`;
            }
            
            applyFilters();
        }

        // Select all datasets (original button)
        function selectAllDatasets() {
            selectAllDatasetsCheckbox();
        }

        // Apply filters
        function applyFilters() {
            const domainFilter = document.getElementById('domain-filter').value.toLowerCase();
            const orgFilter = document.getElementById('org-filter').value.toLowerCase();
            const searchFilter = document.getElementById('search-filter').value.toLowerCase();
            const countryFilter = document.getElementById('country-filter').value.toLowerCase();
            const freqFilter = document.getElementById('freq-filter').value.toLowerCase();
            const dimensionsFilter = document.getElementById('dimensions-filter').value.toLowerCase();

            filteredDatasets = allDatasets.filter(dataset => {
                const matchesDomain = !domainFilter || dataset.Domain.toLowerCase() === domainFilter;
                const matchesOrg = !orgFilter || dataset['Organization'].toLowerCase() === orgFilter;
                const matchesSearch = !searchFilter || 
                    dataset['Dataset Name'].toLowerCase().includes(searchFilter) ||
                    dataset['Organization'].toLowerCase().includes(searchFilter) ||
                    dataset.Description.toLowerCase().includes(searchFilter);
                const matchesCountry = !countryFilter || dataset.Countries.toLowerCase() === countryFilter;
                const matchesFreq = !freqFilter || dataset['Data Publication frequency'].toLowerCase() === freqFilter;
                const matchesDimensions = !dimensionsFilter || 
                    (dataset.Dimensions && dataset.Dimensions.toLowerCase().includes(dimensionsFilter));
                const matchesDatasetSelection = selectedDatasetNames.length === 0 || selectedDatasetNames.includes(dataset['Dataset Name']);

                return matchesDomain && matchesOrg && matchesSearch && matchesCountry && matchesFreq && matchesDimensions && matchesDatasetSelection;
            });

            renderDatasets();
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('domain-filter').value = '';
            document.getElementById('org-filter').value = '';
            document.getElementById('search-filter').value = '';
            document.getElementById('country-filter').value = '';
            document.getElementById('freq-filter').value = '';
            document.getElementById('dimensions-filter').value = '';
            
            // Clear dataset checkboxes
            const checkboxes = document.querySelectorAll('#dataset-options input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            selectedDatasetNames = [];
            document.getElementById('dataset-select-label').textContent = 'All datasets';
            
            sortColumn = null;
            sortDirection = 'asc';
            applyFilters();
        }

        // Switch view
        function switchView(view) {
            currentView = view;
            document.getElementById('cards-btn').classList.toggle('active', view === 'cards');
            document.getElementById('table-btn').classList.toggle('active', view === 'table');
            renderDatasets();
        }

        // Sort table
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            filteredDatasets.sort((a, b) => {
                let valA = a[column] || '';
                let valB = b[column] || '';
                
                const numA = parseFloat(valA);
                const numB = parseFloat(valB);
                if (!isNaN(numA) && !isNaN(numB)) {
                    return sortDirection === 'asc' ? numA - numB : numB - numA;
                }
                
                valA = valA.toString().toLowerCase();
                valB = valB.toString().toLowerCase();
                
                if (sortDirection === 'asc') {
                    return valA.localeCompare(valB);
                } else {
                    return valB.localeCompare(valA);
                }
            });

            renderDatasets();
        }

        // Toggle row expansion
        function toggleRow(index) {
            const expandedRow = document.getElementById(`expanded-${index}`);
            const expandBtn = document.getElementById(`expand-btn-${index}`);
            const mainRow = expandBtn.closest('tr');
            
            if (expandedRow.classList.contains('show')) {
                expandedRow.classList.remove('show');
                expandBtn.classList.remove('expanded');
                mainRow.classList.remove('expanded');
            } else {
                expandedRow.classList.add('show');
                expandBtn.classList.add('expanded');
                mainRow.classList.add('expanded');
            }
        }

        // Toggle card expansion
        function toggleCard(index) {
            const card = document.querySelector(`[data-index="${index}"]`);
            if (card) {
                card.classList.toggle('expanded');
            }
        }

        // Render datasets
        function renderDatasets() {
            const container = document.getElementById('datasets-container');
            const resultsInfo = document.getElementById('results-info');

            resultsInfo.textContent = `${filteredDatasets.length} dataset${filteredDatasets.length !== 1 ? 's' : ''}`;

            if (filteredDatasets.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <h3>No Datasets Found</h3>
                        <p>Try adjusting your filters or search terms.</p>
                    </div>
                `;
                return;
            }

            if (currentView === 'table') {
                container.innerHTML = createTableView();
            } else {
                container.innerHTML = `
                    <div class="datasets-grid">
                        ${filteredDatasets.map((dataset, index) => createDatasetCard(dataset, index)).join('')}
                    </div>
                `;
            }
        }

        // Create table view with expandable rows
        function createTableView() {
            let tableHTML = `
                <div class="table-view">
                    <table class="datasets-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;"></th>
                                <th class="sortable ${sortColumn === 'Dataset Name' ? 'sorted-' + sortDirection : ''}" onclick="sortTable('Dataset Name')">Dataset</th>
                                <th class="sortable ${sortColumn === 'Organization' ? 'sorted-' + sortDirection : ''}" onclick="sortTable('Organization')">Organization</th>
                                <th class="sortable ${sortColumn === 'Domain' ? 'sorted-' + sortDirection : ''}" onclick="sortTable('Domain')">Domain</th>
                                <th>Description</th>
                                <th>Key Metadata</th>
                                <th>Links</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            filteredDatasets.forEach((dataset, index) => {
                tableHTML += createTableRow(dataset, index);
                tableHTML += createExpandedRow(dataset, index);
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return tableHTML;
        }

        // Create table row
        function createTableRow(dataset, index) {
            const metadata = [];
            
            if (dataset['Data Publication frequency']) {
                metadata.push(`<div class="table-metadata-item"><span class="table-metadata-label">Pub. Freq:</span> ${dataset['Data Publication frequency']}</div>`);
            }
            if (dataset.Countries) {
                const countries = dataset.Countries.length > 50 ? dataset.Countries.substring(0, 50) + '...' : dataset.Countries;
                metadata.push(`<div class="table-metadata-item"><span class="table-metadata-label">Countries:</span> ${countries}</div>`);
            }
            if (dataset['Geographical disaggregation']) {
                metadata.push(`<div class="table-metadata-item"><span class="table-metadata-label">Geo Level:</span> ${dataset['Geographical disaggregation']}</div>`);
            }
            
            return `
                <tr>
                    <td>
                        <button class="expand-btn" id="expand-btn-${index}" onclick="toggleRow(${index})"></button>
                    </td>
                    <td>
                        <div class="table-dataset-name">${dataset['Dataset Name']}</div>
                    </td>
                    <td>
                        <div class="table-owner">${dataset['Organization'] || '-'}</div>
                    </td>
                    <td>
                        ${dataset.Domain ? `<span class="table-domain-badge">${dataset.Domain}</span>` : '-'}
                    </td>
                    <td>
                        <div class="table-description">${dataset.Description || '-'}</div>
                    </td>
                    <td>
                        <div class="table-metadata">
                            ${metadata.join('') || '-'}
                        </div>
                    </td>
                    <td>
                        <div class="table-links">
                            ${dataset['API or main ingestion source'] ? `<a href="${dataset['API or main ingestion source']}" class="table-link" target="_blank">API</a>` : ''}
                            ${dataset['HDX Link'] ? `<a href="${dataset['HDX Link']}" class="table-link secondary" target="_blank">HDX</a>` : ''}
                            ${dataset['Data dictionary / Schema'] ? `<a href="${dataset['Data dictionary / Schema']}" class="table-link secondary" target="_blank">Schema</a>` : ''}
                        </div>
                    </td>
                </tr>
            `;
        }

        // Create expanded row content
        function createExpandedRow(dataset, index) {
            const expandedFields = [
                { label: 'Sources', value: dataset.Sources },
                { label: 'Data Collection Frequency', value: dataset['Data collection frequency / ingestion'] },
                { label: 'Disaggregation', value: dataset.Disaggregation },
                { label: 'License', value: dataset.License },
                { label: 'Other Technical Considerations', value: dataset['Other technical considerations'] }
            ].filter(field => field.value);

            return `
                <tr class="expanded-row" id="expanded-${index}">
                    <td colspan="7">
                        <div class="expanded-content">
                            <div class="expanded-grid">
                                ${expandedFields.map(field => `
                                    <div class="expanded-item">
                                        <span class="expanded-label">${field.label}</span>
                                        <span class="expanded-value">${field.value}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Create dataset card HTML (same as before)
        function createDatasetCard(dataset, index) {
            return `
                <article class="dataset-card" data-index="${index}" onclick="toggleCard(${index})">
                    <div class="dataset-header">
                        <div class="dataset-title">
                            <h3>${dataset['Dataset Name']}</h3>
                            <div class="dataset-owner">${dataset['Organization']}</div>
                        </div>
                        ${dataset.Domain ? `<div class="domain-badge">${dataset.Domain}</div>` : ''}
                    </div>

                    <p class="dataset-description">${dataset.Description || 'No description available.'}</p>

                    <div class="expand-toggle">Show details</div>

                    <div class="dataset-expanded-content">
                        <div class="dataset-details">
                            ${dataset.Sources ? `
                                <div class="detail-item">
                                    <span class="detail-label">Sources</span>
                                    <span class="detail-value">${dataset.Sources}</span>
                                </div>
                            ` : ''}
                            ${dataset['Data collection frequency / ingestion'] ? `
                                <div class="detail-item">
                                    <span class="detail-label">Collection Frequency</span>
                                    <span class="detail-value">${dataset['Data collection frequency / ingestion']}</span>
                                </div>
                            ` : ''}
                            ${dataset['Data Publication frequency'] ? `
                                <div class="detail-item">
                                    <span class="detail-label">Publication Frequency</span>
                                    <span class="detail-value">${dataset['Data Publication frequency']}</span>
                                </div>
                            ` : ''}
                            ${dataset.Disaggregation ? `
                                <div class="detail-item">
                                    <span class="detail-label">Disaggregation</span>
                                    <span class="detail-value">${dataset.Disaggregation}</span>
                                </div>
                            ` : ''}
                            ${dataset.Countries ? `
                                <div class="detail-item">
                                    <span class="detail-label">Countries</span>
                                    <span class="detail-value">${dataset.Countries}</span>
                                </div>
                            ` : ''}
                            ${dataset['Geographical disaggregation'] ? `
                                <div class="detail-item">
                                    <span class="detail-label">Geographical Disaggregation</span>
                                    <span class="detail-value">${dataset['Geographical disaggregation']}</span>
                                </div>
                            ` : ''}
                            ${dataset.License ? `
                                <div class="detail-item">
                                    <span class="detail-label">License</span>
                                    <span class="detail-value">${dataset.License}</span>
                                </div>
                            ` : ''}
                        </div>

                        ${createLinksSection(dataset)}

                        ${dataset['Other technical considerations'] ? `
                            <div class="detail-item" style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color);">
                                <span class="detail-label">Technical Considerations</span>
                                <span class="detail-value">${dataset['Other technical considerations']}</span>
                            </div>
                        ` : ''}
                    </div>
                </article>
            `;
        }

        // Create links section
        function createLinksSection(dataset) {
            const links = [];
            
            if (dataset['API or main ingestion source']) {
                links.push(`<a href="${dataset['API or main ingestion source']}" class="link-btn" target="_blank" onclick="event.stopPropagation()">üîó API</a>`);
            }
            if (dataset['HDX Link']) {
                links.push(`<a href="${dataset['HDX Link']}" class="link-btn secondary" target="_blank" onclick="event.stopPropagation()">üìä HDX</a>`);
            }
            if (dataset['Data dictionary / Schema']) {
                links.push(`<a href="${dataset['Data dictionary / Schema']}" class="link-btn secondary" target="_blank" onclick="event.stopPropagation()">üìñ Schema</a>`);
            }

            return links.length > 0 ? `<div class="dataset-links">${links.join('')}</div>` : '';
        }

        // Export to CSV
        function exportToCSV() {
            const headers = [
                'Dataset Name', 'Organization', 'Domain', 'Description', 'Sources',
                'Data collection frequency / ingestion', 'Data Publication frequency',
                'Disaggregation', 'Countries', 'Geographical disaggregation',
                'Data dictionary / Schema', 'API or main ingestion source', 'HDX Link',
                'License', 'Other technical considerations'
            ];

            let csvContent = headers.join(',') + '\n';

            filteredDatasets.forEach(dataset => {
                const row = headers.map(header => {
                    let value = dataset[header] || '';
                    // Escape quotes and wrap in quotes if contains comma, quote, or newline
                    if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                        value = '"' + value.replace(/"/g, '""') + '"';
                    }
                    return value;
                });
                csvContent += row.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const timestamp = new Date().toISOString().split('T')[0];
            link.setAttribute('href', url);
            link.setAttribute('download', `humanitarian_datasets_${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Export to Excel
        function exportToExcel() {
            const headers = [
                'Dataset Name', 'Organization', 'Domain', 'Description', 'Sources',
                'Data collection frequency / ingestion', 'Data Publication frequency',
                'Disaggregation', 'Countries', 'Geographical disaggregation',
                'Data dictionary / Schema', 'API or main ingestion source', 'HDX Link',
                'License', 'Other technical considerations'
            ];

            // Create HTML table
            let tableHTML = '<table><thead><tr>';
            headers.forEach(header => {
                tableHTML += `<th>${header}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';

            filteredDatasets.forEach(dataset => {
                tableHTML += '<tr>';
                headers.forEach(header => {
                    const value = dataset[header] || '';
                    tableHTML += `<td>${value.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</td>`;
                });
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table>';

            // Create a Blob with the table
            const blob = new Blob([`
                <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                <head>
                    <meta charset="utf-8">
                    <!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet>
                    <x:Name>Datasets</x:Name>
                    <x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet>
                    </x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]-->
                    <style>
                        table { border-collapse: collapse; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #00ad78; color: white; font-weight: bold; }
                    </style>
                </head>
                <body>${tableHTML}</body>
                </html>
            `], { type: 'application/vnd.ms-excel' });

            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const timestamp = new Date().toISOString().split('T')[0];
            link.setAttribute('href', url);
            link.setAttribute('download', `humanitarian_datasets_${timestamp}.xls`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Event listeners
        document.getElementById('domain-filter').addEventListener('change', applyFilters);
        document.getElementById('org-filter').addEventListener('change', applyFilters);
        document.getElementById('search-filter').addEventListener('input', applyFilters);
        document.getElementById('country-filter').addEventListener('change', applyFilters);
        document.getElementById('freq-filter').addEventListener('change', applyFilters);
        document.getElementById('dimensions-filter').addEventListener('change', applyFilters);

        // Load datasets on page load
        loadDatasets();
    </script>
</body>
</html>
